{{- $componentName := include "kubeflow.centraldashboard.name" . -}}
{{- $autoscalingEnabled := include "kubeflow.centraldashboard.autoscaling.enabled" . -}}
{{- $minReplicas := include "kubeflow.centraldashboard.autoscaling.minReplicas" . -}}

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    {{- include "kubeflow.centraldashboard.labels" . | nindent 4 }}
  name: {{ $componentName }}
spec:
  {{- if (eq $autoscalingEnabled "false") }}
  replicas: {{ $minReplicas }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "kubeflow.centraldashboard.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "kubeflow.centraldashboard.selectorLabels" . | nindent 8 }}
    spec:
      containers:
      - name: {{ $componentName }}
        image: {{ include "kubeflow.centraldashboard.image" . }}
        imagePullPolicy: {{ include "kubeflow.centraldashboard.imagePullPolicy" . }}

        livenessProbe:
          httpGet:
            path: /healthz
            port: 8082
          initialDelaySeconds: 30
          periodSeconds: 30

        ports:
        - containerPort: 8082
          protocol: TCP

        env:
        - name: USERID_HEADER
          value: {{ .Values.auth.userHeaderName }}

        - name: USERID_PREFIX
          value: {{ .Values.auth.userIdPrefix | quote }}

        - name: PROFILES_KFAM_SERVICE_HOST
          value: {{ printf "profiles-kfam.%s" .Release.Namespace }}

        - name: REGISTRATION_FLOW
          value: {{ .Values.centraldashboard.config.enableRegistrationFlow | quote }}

        - name: DASHBOARD_LINKS_CONFIGMAP
          value: {{ include "kubeflow.centraldashboard.config.name" . }}

        - name: LOGOUT_URL
          value: {{ .Values.centraldashboard.config.logoutURL }}

        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace

      serviceAccountName: {{ include "kubeflow.centraldashboard.serviceAccountName" . }}
